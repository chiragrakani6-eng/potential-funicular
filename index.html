<!doctype html>
<html lang="en">
<head><meta name="google-site-verification" content="3eaXJGv-ZqmwYM_BjDHmI2YNI1l4AnqP8VIJcru710s" />
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chirag Rakani Accessible Tools Hub</title>
  <meta name="description" content="Accessible tools by Chirag Rakani typing OCR PDF/Image games location & social links">
  <meta name="theme-color" content="#2c3e50">

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{--bg:#f4f7fb;--card:#fff;--accent:#2c3e50;--accent2:#27ae60;--muted:#666;--error:#c0392b}
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
    header{background:var(--accent);color:#fff;padding:14px 16px}
    .container{max-width:980px;margin:18px auto;padding:0 14px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:320px 1fr}}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h2{margin:0 0 8px 0}
    h3{margin:8px 0 6px 0}
    .small{font-size:0.95rem;color:var(--muted)}
    .btn{background:var(--accent2);color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer;min-width:120px;margin-right:8px}
    .btn-alt{background:#3b82f6}
    .btn-danger{background:var(--error)}
    .output{background:#fafafa;padding:12px;border-radius:6px;border:1px solid #e6e6e6;min-height:120px;white-space:pre-wrap;overflow:auto}
    .typing-controls{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    input[type="text"], input[type="number"], textarea, select{padding:10px;border-radius:6px;border:1px solid #ddd;width:100%}
    footer{padding:14px;text-align:center;color:var(--muted)}
    a.social{color:var(--accent);text-decoration:none;margin-right:8px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;}
    
    /* Typing specific styles */
    .typing-box{padding:10px;border:1px solid #eee;border-radius:6px;background:#fbfff6;margin-bottom:8px}
    #wpmText, #tutorTextDisplay{line-height:1.6;font-size:1.1rem;margin-bottom:8px;white-space: pre-wrap;}
    .highlight-current-tutor{background-color: #ffda6a; padding: 2px 0; border-radius: 2px;}
    .highlight-typed-tutor-correct{color: green; font-weight: bold;}
    .highlight-typed-tutor-error{color: var(--error); background-color: #fdd; font-weight: bold; padding: 1px 0;}
    .tutor-stats{font-weight: 600; margin-top: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee;}
    #qrOutput img {border: 1px solid #ddd; padding: 5px; background: #fff;}

    /* Auth screen styles */
    .auth-card{max-width: 400px; margin: 100px auto; padding: 25px; text-align: center;}
    .auth-card button{margin: 8px 0; width: 100%;}
  </style>
</head>
<body>
  <header>
    <div style="display:flex;gap:12px;align-items:center">
      <div style="width:56px;height:56px;border-radius:10px;background:#fff;color:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700">CR</div>
      <div>
        <h1 style="font-size:1.05rem;margin:0">Chirag Rakani Accessible Tools & Games Hub</h1>
        <div class="small">Typing, OCR, PDF/Image Reading, Games, and Utilities</div>
      </div>
    </div>
  </header>

  <section id="authScreen" class="container auth-card">
    <h2>Sign Up / Log In to Access Tools</h2>
    <p class="small">Please sign up or log in to use the typing tutor, OCR, and other utilities.</p>
    
    <button class="btn btn-alt" onclick="startAuthFlow('phone')">üìû Sign up/Login with Phone (OTP)</button>
    <button class="btn btn-alt" onclick="startAuthFlow('email')">üåê Sign up/Login with Email/Google</button>
    
    <div id="authFormContainer" style="margin-top: 15px; text-align: left; display: none;">
        <p id="authPrompt" class="small" style="font-weight: 600; margin-bottom: 8px;">Enter Details:</p>
        <input id="authPrimaryInput" type="text" placeholder="Enter phone/email" aria-label="Phone or Email Input">
        <input id="authSecondaryInput" type="text" placeholder="Enter OTP/Password" aria-label="OTP or Password Input" style="margin-top: 8px;">
        <button class="btn" id="authVerifyBtn" style="width: 100%; margin-top: 12px;">Verify & Access</button>
    </div>
    
    <div id="authStatus" class="small" style="margin-top: 10px;" aria-live="polite">Simulated login. Click any button to continue.</div>
  </section>

  <section id="vipCheckScreen" class="container auth-card" style="display:none;">
    <h2>Accessibility Check</h2>
    <p>This tool is designed with high accessibility standards. To better tailor your experience, please confirm:</p>
    <h3>Are you visually impaired?</h3>
    <div style="text-align: left; margin: 20px 0;">
        <label style="display: block; margin: 10px 0; font-size: 1.1rem;">
            <input type="radio" name="vip-status" value="yes" id="vipYes"> Yes
        </label>
        <label style="display: block; margin: 10px 0; font-size: 1.1rem;">
            <input type="radio" name="vip-status" value="no" id="vipNo"> No
        </label>
    </div>
    <button class="btn" onclick="handleVIPCheck()">Confirm and Proceed</button>
    <div id="vipStatus" class="small" style="margin-top: 10px;" aria-live="polite"></div>
  </section>


  <main id="appContainer" class="container" style="display:none;">
    <div class="grid">
      <aside class="card">
        <h2>About Me</h2>
        
        <p class="small" style="font-weight: bold;">
            I'm **Chirag Rakani** from **Gharana, Kutch, Gujarat**. I am dedicated to **developing intuitive and accessible tools and applications** for the **visually impaired community**. My goal is to empower users through high-quality, efficient software like this ultimate typing tutor, advanced OCR reader, and utility hub.
        </p>
        

        <h3>Buy my books</h3>
        <p class="small">
          <a class="social" href="https://amzn.to/48Tnv7r" target="_blank" rel="noopener noreferrer">Amazon Link 1</a><br>
          <a class="social" href="https://www.amazon.in/dp/B0FXBS6X6Z/ref=cm_sw_r_as_gl_apa_gl_i_NFFK753K6FK4F891H3MT?linkCode=ml1&tag=chiragrakani9-21&linkId=c26819af71b220eee7166bcb96218d56" target="_blank" rel="noopener noreferrer">Amazon Book Buy</a>
        </p>

        <h3>Contact & Social</h3>
        <p class="small">üìû 9737796825<br>‚úâÔ∏è <a href="mailto:chiragrakani6@gmail.com">chiragrakani6@gmail.com</a></p>
        <div class="small">
          <a class="social" href="https://youtube.com/shorts/Us4sDykOYtc?si=ITbIS3l6enuNzF29" target="_blank">YouTube</a>
          <a class="social" href="https://www.facebook.com/share/1DH4fAcwqU/" target="_blank">Facebook</a>
          <a class="social" href="https://www.instagram.com/koli.chirag?igsh=cGNyaTIyNXQ1NWM2" target="_blank">Instagram</a>
        </div>
      </aside>

      <section>
        <article class="card" id="typing-tutor-card">
          <h2>Azabat-Style Typing Tutor (11 Exercises)</h2>
          <p class="small">Live WPM and Error tracking added for a professional training experience.</p>
          <div id="tutorPanel">
            <div id="tutorStatus" class="typing-box">Press Load Exercise or Start Tutor to begin</div>
            <div id="tutorStats" class="tutor-stats">WPM: 0 | Errors: 0 | Time: 0s</div>
            <p id="tutorTextDisplay" style="white-space: pre-wrap;">Welcome to the Typing Tutor. Use the menu below to select an exercise.</p>
            <input id="tutorInput" type="text" placeholder="Start typing the sequence/words shown above" aria-label="Typing Tutor Input" disabled>
          </div>
          <div class="typing-controls">
            <select id="tutorExSelect" aria-label="Select Typing Exercise" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; min-width: 200px;">
              </select>
            <button id="loadExBtn" class="btn btn-alt" style="min-width: 150px;">Load Selected Exercise</button>
            <button id="tutorBtn" class="btn">‚ñ∂ Start Tutor</button>
          </div>
        </article>
        
        <hr/>
        
        <article class="card" style="margin-top:12px" id="wpm-card">
          <h2>Typing WPM Test (Paragraphs)</h2>
          <p class="small">Type the highlighted text as fast and accurately as possible to calculate your WPM score.</p>
          
          <div id="wpmText" class="typing-box">Click Start WPM Test to load the paragraph</div>
          <input id="wpmInput" type="text" placeholder="Start typing here" aria-label="WPM Test Input" disabled>
          
          <div class="typing-controls">
            <button id="wpmStartBtn" class="btn">‚ñ∂ Start WPM Test</button>
            <div id="wpmResults" style="font-weight:600;margin-left:8px">WPM: 0 | Errors: 0 | Time: 0s | Acc: 0%</div>
          </div>
        </article>

        <hr/>
        
        <article class="card" style="margin-top:12px" id="typing-card">
          <h2>Typing Practice Endless Spelling</h2>
          <p class="small">**Accessibility Focus:** F2 key repeats spelling or full word (Double F2). Get it wrong once, and you must type it correctly 3 times to proceed.</p>

          <div id="practiceWord" class="typing-box">Loading practice word</div>

          <input id="practiceInput" type="text" placeholder="Type the word here" aria-label="Type the word here">

          <div class="typing-controls">
            <button id="nextWordBtn" class="btn">üîÑ Next Word</button>
            <button id="listenBtn" class="btn">üîä Listen Word</button>
            <button id="spellBtn" class="btn btn-alt">üî° Spell Word (F2)</button>
            <div id="spellFeedback" aria-live="assertive" style="font-weight:600;margin-left:8px"></div>
          </div>
        </article>
        
        <hr/>
        
        <article class="card" style="margin-top:12px">
          <h2>Document Reader (Perfected OCR & PDF Reading)</h2>
          <p class="small">Upload an **Image** or **PDF**. OCR supports English, Hindi, and Gujarati. <span style="color:var(--error);font-weight:bold;">NOTE: Microsoft Publisher (.pub) files cannot be read directly in the browser; please convert them to PDF or Image first.</span></p>

          <input id="fileInput" type="file" accept="image/*, .pdf" style="margin-top:8px">
          <div style="margin-top:8px" class="typing-controls">
            <button id="processBtn" class="btn">üìÅ Process File</button>
            <div id="pdf-controls" style="display:none;align-items:center">
              <label style="display:flex;align-items:center;gap:6px">Page:
                <input id="pageNumberInput" type="number" min="1" value="1" style="width:80px;padding:8px">
              </label>
              <button id="goPageBtn" class="btn">Go</button>
              <span id="pageInfo" class="small" style="margin-left:8px"></span>
            </div>
          </div>

          <h3 style="margin-top:12px">Result Text:</h3>
          <div id="doc-output" class="output" tabindex="0" aria-live="polite">Extracted text will appear here</div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <label><input id="autoLang" type="checkbox" checked> Auto Read Result</label>
            <label style="margin-left:6px">Force Lang:
              <select id="forceLang" style="padding:8px">
                <option value="">Auto</option>
                <option value="en-IN">English</option>
                <option value="hi-IN">Hindi</option>
                <option value="gu-IN">Gujarati</option>
              </select>
            </label>
            <button id="readDoc" class="btn">üîä Read Text</button>
            <button id="stopRead" class="btn btn-danger">‚èπ Stop Read</button>
            <div id="readStatus" class="small" style="margin-left:8px"></div>
          </div>
        </article>

        <hr/>
        
        <article class="card" style="margin-top:12px">
          <h2>Utility Tools</h2>

          <h3>QR Code Generator</h3>
          <p class="small">Enter any text or URL to generate a scannable QR Code.</p>
          <input id="qrInput" type="text" placeholder="Enter text or URL" aria-label="QR Code Input">
          <div id="qrOutput" style="margin-top:8px; min-height: 50px;"></div>
          <button id="qrGenerateBtn" class="btn">Generate QR</button>
          
          <h3 style="margin-top:12px">Text to Speech</h3>
          <p class="small">Enter text and press Speak to hear it read aloud.</p>
          <textarea id="ttsInput" placeholder="Enter text to speak" rows="3"></textarea>
          <div class="typing-controls">
            <button id="ttsSpeakBtn" class="btn">üîä Speak</button>
          </div>
          
          <h3 style="margin-top:12px">Translator (External Link)</h3>
          <p class="small">Opens Google Translate in a new tab.</p>
          <textarea id="translateInput" placeholder="Enter text to translate" rows="3"></textarea>
          <div class="typing-controls">
            <div style="display:flex;gap:8px;width:100%">
              <select id="translateSource" style="width:50%">
                <option value="auto">Auto-detect</option>
                <option value="en">English</option>
                <option value="hi">Hindi</option>
                <option value="gu">Gujarati</option>
              </select>
              <select id="translateTarget" style="width:50%">
                <option value="hi">Hindi</option>
                <option value="en">English</option>
                <option value="gu">Gujarati</option>
              </select>
            </div>
            <button id="translateBtn" class="btn">Open Translation</button>
          </div>

          <h3 style="margin-top:12px">Where Am I Location</h3>
          <p class="small">Tap the button and allow browser location permission.</p>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="locBtn" class="btn">üìç Get Current Location</button>
            <div id="locationOutput" class="small" style="margin-left:8px"></div>
          </div>
        </article>

        <hr/>
        
        <article class="card" style="margin-top:12px">
          <h2>Accessible Games</h2>
          <p class="small">Simple games for fun and relaxation.</p>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn" onclick="window.open('https://lichess.org','_blank')">‚ôüÔ∏è Play Chess Lichess (External)</button>
            
            <details style="margin-top: 8px;">
                <summary style="font-weight: bold; cursor: pointer; padding: 5px; background: #f0f0f0; border-radius: 5px;">üèè Hand Cricket</summary>
                <div id="handPanel" style="padding-top: 10px;">
                    <div id="hcStatus" class="small">Ready</div>
                    <input id="hcInput" type="number" min="0" max="6" placeholder="1-6" style="width:90px;margin-top:6px">
                    <div style="margin-top:8px">
                    <button id="hcPlay" class="btn">Play</button>
                    <button id="hcReset" class="btn" style="background:#777">Reset</button>
                    </div>
                </div>
            </details>

            <details style="margin-top: 8px;">
                <summary style="font-weight: bold; cursor: pointer; padding: 5px; background: #f0f0f0; border-radius: 5px;">üé≤ Snakes & Ladders (Simplified)</summary>
                <div id="snlPanel" style="padding-top: 10px;">
                    <div id="snlStatus" class="small">Ready</div>
                    <div style="margin-top:8px">
                    <button id="snlRoll" class="btn">Roll Dice</button>
                    <button id="snlReset" class="btn" style="background:#777">Reset</button>
                    <div id="snlDice" class="small" style="display:inline-block;margin-left:12px;font-size: 1.1rem; font-weight: bold;">-</div>
                    </div>
                </div>
            </details>

            <details style="margin-top: 8px;">
                <summary style="font-weight: bold; cursor: pointer; padding: 5px; background: #f0f0f0; border-radius: 5px;">üéØ Ludo Race (1 Player vs 3 AI)</summary>
                <div id="ludoPanel" style="padding-top: 10px;">
                    <div id="ludoStatus" class="small">Ready</div>
                    <div style="margin-top:8px">
                    <button id="ludoRoll" class="btn">Your Roll</button>
                    <button id="ludoReset" class="btn" style="background:#777">Reset</button>
                    </div>
                    <div id="ludoScores" class="small" style="margin-top:8px; font-weight: bold;"></div>
                </div>
            </details>
          </div>
        </article>

      </section>
    </div>
  </main>

  <footer>¬© 2025 Chirag Rakani Accessible Tools Hub</footer>

  <div id="ann" class="sr-only" aria-live="assertive"></div>

<script>
/* ==================== GLOBAL AUTHENTICATION LOGIC (FIXED) ==================== */

// Utility for managing screen display
function showScreen(screenId) {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('vipCheckScreen').style.display = 'none';
    document.getElementById('appContainer').style.display = 'none';
    
    if (screenId) {
        document.getElementById(screenId).style.display = 'block';
    }
}

// Utility: Speech
function speak(text, lang='en-US', rate=0.95){
  if(!('speechSynthesis' in window)) return;
  try{ window.speechSynthesis.cancel(); }catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang;
  u.rate = rate;
  window.speechSynthesis.speak(u);
}

let currentAuthMethod = '';
const authFormContainer = document.getElementById('authFormContainer');
const authPrompt = document.getElementById('authPrompt');
const authPrimaryInput = document.getElementById('authPrimaryInput');
const authSecondaryInput = document.getElementById('authSecondaryInput');
const authVerifyBtn = document.getElementById('authVerifyBtn');
const authStatus = document.getElementById('authStatus');

function startAuthFlow(method) {
    currentAuthMethod = method;
    authFormContainer.style.display = 'block';
    authStatus.innerText = '';
    
    if (method === 'phone') {
        authPrompt.innerText = 'Enter your Phone Number:';
        authPrimaryInput.placeholder = 'e.g., 9737796825';
        authSecondaryInput.placeholder = 'Enter 6-digit OTP (Simulated: 123456)';
        authSecondaryInput.style.display = 'block';
        authVerifyBtn.innerText = 'Verify OTP & Access';
        speak('Please enter your phone number and the simulated OTP.');
    } else if (method === 'email') {
        authPrompt.innerText = 'Enter your Email (for Google/Microsoft Login):';
        authPrimaryInput.placeholder = 'e.g., user@example.com';
        authSecondaryInput.placeholder = 'Enter Password (Simulated)';
        authSecondaryInput.style.display = 'block';
        authVerifyBtn.innerText = 'Log In & Access';
        speak('Please enter your email and a simulated password.');
    }
    
    authPrimaryInput.value = '';
    authSecondaryInput.value = '';
    authPrimaryInput.focus();
}

authVerifyBtn.addEventListener('click', () => {
    const primaryValue = authPrimaryInput.value.trim();
    const secondaryValue = authSecondaryInput.value.trim();
    
    if (primaryValue.length < 5) {
        authStatus.innerText = 'Please enter a valid phone or email.';
        speak('Please enter a valid input.');
        return;
    }

    if (currentAuthMethod === 'phone' && secondaryValue !== '123456') {
        authStatus.innerText = '‚ùå Verification Failed. Please use the simulated OTP: 123456';
        speak('Verification Failed. Please use the simulated OTP: 1 2 3 4 5 6.');
        return;
    }
    
    // Success path (simulated)
    authStatus.innerHTML = `‚úÖ Successfully logged in via ${currentAuthMethod === 'phone' ? 'Phone (OTP)' : 'Email'}. Proceeding to accessibility check...`;
    speak(`Successfully logged in. Proceeding to accessibility check.`, 'en-US'); 
    
    // Direct transition to the next screen
    setTimeout(() => {
        showScreen('vipCheckScreen');
        document.querySelector('#vipCheckScreen h3').focus();
        speak("Are you visually impaired? Please confirm your status to proceed.", 'en-US');
    }, 500);
});


function handleVIPCheck() {
    const vipYes = document.getElementById('vipYes').checked;
    const vipNo = document.getElementById('vipNo').checked;
    const status = document.getElementById('vipStatus');

    if (!vipYes && !vipNo) {
        status.innerText = 'Please select Yes or No to confirm.';
        speak('Please select Yes or No to confirm.');
        return;
    }

    const message = vipYes ? 
        'Thank you! The application will optimize for screen reader and keyboard-only navigation.' : 
        'Preference recorded. Welcome to the application!';

    status.innerText = message;
    speak(message);
    
    // Simulate setting a preference and unlocking the app
    localStorage.setItem('isVisuallyImpaired', vipYes ? 'true' : 'false');

    // Direct transition to the app
    showScreen('appContainer');
    speak('Application unlocked. Welcome to the tools hub.');
}

// Initial check to determine which screen to show on load
document.addEventListener('DOMContentLoaded', () => {
    // If a VIP status is already set (simulating persistent login)
    if (localStorage.getItem('isVisuallyImpaired') !== null) {
        showScreen('appContainer');
        speak('Welcome back to the tools hub.');
    } else {
        showScreen('authScreen');
    }
    
    // Initialize all tool components
    initializeTypingTutor();
    initializeWPMTest();
    initializeEndlessSpelling();
    initializeGames();
});

/* ==================== Typing Practice (Endless Spelling) ==================== */
const wordsWithUsage = {
    "accessibility": "We are designing this tool for better web accessibility", "computer": "I use the computer for all my data entry tasks", "keyboard": "My typing speed is fast because I use the keyboard efficiently", "software": "I am competent in using Microsoft Office software", "screenreader": "A screenreader is essential for navigating the internet", "braille": "I learned to read using the braille system in school", "typing": "I am seeking a typing related position", "success": "Success requires dedication and consistent practice", "motivation": "I have high motivation to learn new skills", "efficiency": "Typing proficiency ensures high efficiency", "communication": "Strong verbal and written communication skills are needed for chat support", "technology": "Assistive technology helps visually impaired people work effectively", "challenge": "I enjoy solving puzzles and logical challenges", "dedication": "Dedication and consistent practice are important", "confidence": "My confidence in my skills is very high", "amazing": "This accessibility feature is truly amazing", "support": "I can provide excellent customer support", "document": "Please review the document before printing", "location": "I am trying to find my current location", "internet": "Internet access is required for online work", "navigation": "Website navigation must be simple and clear", "paragraph": "I will type the entire paragraph quickly", "proficiency": "I have high proficiency in multilingual communication", "essential": "Attention to detail is essential for data entry", "accurate": "I ensure fast and accurate typing", "experience": "I have customer interaction experience", "organization": "I wish to contribute to the organization's success", "solution": "The problem solving team found a perfect solution", "applicant": "The job applicant submitted a strong resume", "objective": "My career objective is to work in tech support", "multilingual": "I am fluent making me a multilingual candidate", "approachable": "I am a friendly and approachable person", "customer": "I focus on helping every customer resolve their issues", "service": "I am passionate about customer service", "position": "I am seeking a data entry position", "utilize": "I will utilize my skills effectively", "contribute": "I am eager to contribute to the team", "gujarat": "I am currently living in Gujarat", "make": "I want to make me happy"
};

const words = Object.keys(wordsWithUsage);

let curr = "";
let madeWrong = false;
let streak = 0;
let lastF2Press = 0;
const F2_TIMEOUT = 500;

const practiceInput = document.getElementById('practiceInput');
const practiceWord = document.getElementById('practiceWord');
const feedback = document.getElementById('spellFeedback');
const nextWordBtn = document.getElementById('nextWordBtn');
const listenBtn = document.getElementById('listenBtn');
const spellBtn = document.getElementById('spellBtn');

function nextWord(){
  madeWrong = false;
  streak = 0;
  curr = words[Math.floor(Math.random()*words.length)];
  let usage = wordsWithUsage[curr];

  practiceWord.innerText = `üîä Word: ${curr} | üìñ Usage: ${usage}`;
  feedback.innerText = "Word loaded. Type the word.";
  practiceInput.value = "";
  practiceInput.focus();

  speak(`The word is ${curr}`);
  setTimeout(() => speak(`Usage in a sentence: ${usage}`, 'en-US', 0.8), 1500);
}

function spellOut(word){
  if(!word) return;
  const s = word.toUpperCase().split('').join(' ');
  speak("Spelling " + s);
  feedback.innerText = `Spelling: ${word.toUpperCase().split('').join(' ¬∑ ')}`;
}

function onType(e){
  const typed = practiceInput.value.trim().toLowerCase();
  
  if(e.type === 'keydown'){
    if(e.key === 'F2'){ 
      e.preventDefault(); 
      const now = new Date().getTime();

      if (now - lastF2Press < F2_TIMEOUT) {
        speak(curr);
        feedback.innerText = `üîä Repeating full word: ${curr}`;
        lastF2Press = 0;
      } else {
        spellOut(curr);
        lastF2Press = now;
      }
      return;
    }

    if(e.key === 'Enter'){ 
      e.preventDefault();
      
      if(!curr) { feedback.innerText = "Press Next Word to start"; speak("Press Next Word to start"); return; }
      const correctWord = curr.toLowerCase();
      
      if(typed === correctWord){
          if(!madeWrong) {
             feedback.innerHTML = '<span style="color:green">‚úÖ Correct! Next word.</span>';
             speak("Correct. Next word.");
             setTimeout(nextWord,700);
             return;
          } 

          streak++;
          practiceInput.value = "";
          
          if(streak >= 3){
              feedback.innerHTML = '<span style="color:green">üéâ Done! 3 correct. Next word.</span>';
              speak("Excellent! Next word.");
              setTimeout(nextWord,700);
          } else {
              feedback.innerHTML = `<span style="color:green">‚úÖ Correct ${streak}/3. Type again.</span>`;
              speak(`Correct ${streak} of 3. Type again.`);
          }
      } else {
          madeWrong = true;
          streak = 0;
          practiceInput.value = "";
          feedback.innerHTML = `<span style="color:#c0392b">‚ùå Incorrect. Attempts reset. Listen to spelling now.</span>`;
          setTimeout(()=> spellOut(curr), 200);
          setTimeout(()=> speak("Now you must type the correct word three times."), 1000);
      }
      return;
    }
  }

  if(e.type !== 'input') return;
  if(!curr){ feedback.innerText = "Press Next Word to start"; return; }
  
  const correctWord = curr.toLowerCase();

  if(!madeWrong && typed === correctWord){
    feedback.innerHTML = '<span style="color:green">‚úÖ Correct! Next word.</span>';
    speak("Correct. Next word.");
    setTimeout(nextWord, 600);
    return;
  }

  if(typed.length > 0 && !correctWord.startsWith(typed)){
    madeWrong = true;
    streak = 0;
    practiceInput.value = "";
    feedback.innerHTML = `<span style="color:#c0392b">‚ùå Incorrect. Attempts reset. Listen to spelling now.</span>`;
    setTimeout(()=> spellOut(curr), 200);
    setTimeout(()=> speak("Now you must type the correct word three times."), 1000);
    return;
  }
  
  if(typed.length > 0) {
      feedback.innerText = madeWrong ? `Keep typing (${streak}/3 attempts done)` : `Keep typing`;
  } else {
      feedback.innerText = madeWrong ? `Start typing. The word is ${curr}` : `Type the word.`;
  }
}

function initializeEndlessSpelling() {
    // hooks
    nextWordBtn.addEventListener('click', nextWord);
    listenBtn.addEventListener('click', ()=>{ if(curr) speak(curr); else nextWord(); });
    spellBtn.addEventListener('click', ()=> spellOut(curr));
    practiceInput.addEventListener('input', onType);
    practiceInput.addEventListener('keydown', onType);
    nextWord(); // Load the first word on initialization
}

/* ==================== Azabat-Style Typing Tutor (FIXED) ==================== */

// Helper to create the long drill sequence with forward and backward runs
function createDrill(keys, repetitions = 6) {
    const forward = keys.join(' ');
    const reversed = [...keys].reverse().join(' ');
    // Adds a space to separate repetitions
    const basicSequence = forward + ' ' + reversed + ' '; 
    return basicSequence.repeat(repetitions);
}

// Define key sets
const homeKeys = ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', ';'];
const bottomKeys = ['z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/'];
const upperKeys = ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', '[', ']', '\\'];
const numberKeys = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-', '='];

// Updated Exercises Array (Total 11)
const tutorExercises = [
    // Phase 1: Home Row Drills
    { type: 'drill', name: 'Home Row Drill', 
      instruction: 'Home Row Keys. Type the sequence 6 times: a s d f g h j k l ; ...', 
      sequence: createDrill([...homeKeys], 6) }, 

    // Phase 2: Bottom Row Drills
    { type: 'drill', name: 'Bottom Row Drill', 
      instruction: 'Bottom Row Keys. Type the sequence 6 times: z x c v b n m , . / ...',
      sequence: createDrill([...bottomKeys], 6) }, 

    // Phase 3: Upper Row Drills
    { type: 'drill', name: 'Upper Row Drill', 
      instruction: 'Upper Row Keys. Type the sequence 6 times: q w e r t y u i o p [ ] \\ ...',
      sequence: createDrill([...upperKeys], 6) },

    // Phase 4: Number Row Drills
    { type: 'drill', name: 'Number Row Drill', 
      instruction: 'Number Row Keys. Type the sequence 6 times: 1 2 3 4 5 6 7 8 9 0 - = ...',
      sequence: createDrill([...numberKeys], 6) },
      
    // Phase 5: Random Key Drill (New mode: single-key input)
    { type: 'random_key', name: 'All Three Rows Random Key (25 Keys)', 
      instruction: 'Listen for the spoken key and press it. (25 random keys)',
      sequence: [...homeKeys, ...bottomKeys, ...upperKeys].filter(k => k.length === 1).join(' ') // Key pool
    },
      
    // Phase 6: Home Row Words
    { type: 'word', name: 'Home Row Words', 
      instruction: 'Words using only Home Row Keys.', 
      sequence: 'dad fad sad had has hash dash slash lass adds fall flag gas has lash had salad dash lads dallas all adds gas half dash glad salad fall as dad had ' },

    // Phase 7: Bottom Row Words
    { type: 'word', name: 'Bottom Row Words', 
      instruction: 'Words using only Bottom Row Keys.', 
      sequence: 'zebra zip wax box calm mix next man vice zero cut come max vex zx base box man mix zinc cave next max base comma box ' },

    // Phase 8: Upper Row Words
    { type: 'word', name: 'Upper Row Words', 
      instruction: 'Words using only Upper Row Keys.', 
      sequence: 'quiet wire tree pure type put root your pipe open oil tear trip port power route out top tour true were wet up oil pipe year open tear trip your out port power route ' },

    // Phase 9: Home + Bottom Row Words
    { type: 'word', name: 'Home & Bottom Row Words (Mixed)', 
      instruction: 'Words using Home and Bottom Row Keys.', 
      sequence: 'bad case sad man face slab bag lads have vast mix mass glad base calm has can save lab sad man all add and max axe base ' },
    
    // Phase 10: Home + Upper Row Words
    { type: 'word', name: 'Home & Upper Row Words (Mixed)', 
      instruction: 'Words using Home and Upper Row Keys.', 
      sequence: 'eight sad lady put ask you flow fire wire oil all hope truth youth glass father had was top try saw pop out as if get joy lad low ' },

    // Phase 11: All Rows Words (Comprehensive Mix)
    { type: 'word', name: 'All Rows Mix Words (Comprehensive)', 
      instruction: 'Comprehensive practice using all key rows.',
      sequence: 'quality pizza seven jump quite brown lazy next quick fox six zero one two three four five nine ten eleven twelve thirteen fourteen fifteen sixteen seventeen ' }
];

let currentTutorExIndex = 0;
let tutorCurrentSequence = '';
let tutorCurrentIndex = 0;
let tutorErrors = 0;
let isTutorActive = false;
let tutorStartTime = null;
let totalCorrectChars = 0;
let tutorTimerInterval = null;

const tutorStatus = document.getElementById('tutorStatus');
const tutorInput = document.getElementById('tutorInput');
const tutorBtn = document.getElementById('tutorBtn');
const tutorTextDisplay = document.getElementById('tutorTextDisplay');
const tutorStats = document.getElementById('tutorStats');
const tutorExSelect = document.getElementById('tutorExSelect'); // New
const loadExBtn = document.getElementById('loadExBtn'); // New


// Global state for random key mode
let requiredRandomKey = '';
let randomKeySequence = [];
let randomKeyIndex = 0;
const RANDOM_KEY_TOTAL = 25; // Limiting the random keys to 25

// --- Tutor Utility Functions ---

// Helper to convert key for better speech pronunciation (Space fix helper)
function getSpeakableChar(char) {
    if (char === ' ') return 'SPACE';
    if (char === ';') return 'SEMI-COLON';
    if (char === ',') return 'COMMA';
    if (char === '.') return 'DOT';
    if (char === '/') return 'SLASH';
    if (char === '[') return 'LEFT BRACKET';
    if (char === ']') return 'RIGHT BRACKET';
    if (char === '\\') return 'BACKSLASH';
    if (char === '-') return 'HYPHEN';
    if (char === '=') return 'EQUALS';
    return char;
}

function calculateTutorStats() {
    if (!tutorStartTime) return { wpm: 0, errors: 0, time: 0 };
    const timeElapsedSeconds = (new Date().getTime() - tutorStartTime) / 1000;
    const minutes = timeElapsedSeconds / 60;
    
    // WPM calculation: (Correct Characters / 5) / Minutes
    const wpm = minutes > 0 ? Math.round((totalCorrectChars / 5) / minutes) : 0;
    
    tutorStats.innerText = `WPM: ${wpm} | Errors: ${tutorErrors} | Time: ${Math.floor(timeElapsedSeconds)}s`;
}

function startTutorTimer() {
    if (tutorTimerInterval) clearInterval(tutorTimerInterval);
    tutorStartTime = new Date().getTime();
    calculateTutorStats(); // Initial update
    tutorTimerInterval = setInterval(calculateTutorStats, 1000);
}

function stopTutorTimer() {
    if (tutorTimerInterval) clearInterval(tutorTimerInterval);
    tutorTimerInterval = null;
}

// --- Logic for Random Key Mode (Exercise 5) ---

function generateRandomKeys(keys) {
    let pool = keys.split(' ').filter(k => k.length > 0);
    const result = [];
    for(let i=0; i<RANDOM_KEY_TOTAL; i++) {
        const randomIndex = Math.floor(Math.random() * pool.length);
        result.push(pool[randomIndex]);
    }
    return result;
}

function startRandomKeyMode(keys) {
    tutorInput.value = '';
    tutorInput.disabled = false;
    tutorInput.focus();
    
    randomKeySequence = generateRandomKeys(keys);
    randomKeyIndex = 0;
    requiredRandomKey = randomKeySequence[0];
    tutorStartTime = null; // Start timer on first keypress
    totalCorrectChars = 0;
    tutorErrors = 0;
    
    updateRandomKeyDisplay();
    tutorStats.innerText = 'WPM: 0 | Errors: 0 | Time: 0s';
    
    speak(`Random key drill started. Press the key: ${getSpeakableChar(requiredRandomKey)}`, 'en-US', 1.2);
}

function updateRandomKeyDisplay() {
    tutorTextDisplay.innerHTML = `Keys Completed: ${randomKeyIndex}/${RANDOM_KEY_TOTAL}<br>`;
    
    let displayHtml = '';
    for(let i=0; i<randomKeySequence.length; i++) {
        const displayKey = getSpeakableChar(randomKeySequence[i]);
        
        if (i < randomKeyIndex) {
            displayHtml += `<span class="highlight-typed-tutor-correct">${displayKey.replace('SPACE', '_')}</span>`;
        } else if (i === randomKeyIndex) {
            displayHtml += `<span class="highlight-current-tutor">${displayKey.replace('SPACE', '_')}</span>`;
        } else {
            displayHtml += displayKey.replace('SPACE', '_');
        }
        displayHtml += ' ';
    }
    tutorTextDisplay.innerHTML += `<div style="font-size: 1.5rem; letter-spacing: 5px; white-space: pre-wrap;">${displayHtml}</div>`;
}

// --- Main Tutor Functions ---

function updateTutorTextDisplay() {
    // Only for 'drill' and 'word' types
    const sequence = tutorCurrentSequence;
    const currentInput = tutorInput.value;

    let displayHtml = '';
    
    for (let i = 0; i < sequence.length; i++) {
        const requiredChar = sequence[i];
        
        if (i < tutorCurrentIndex) {
            // Already typed and confirmed correct
            displayHtml += `<span class="highlight-typed-tutor-correct">${requiredChar}</span>`;
        } else if (i === tutorCurrentIndex) {
            // Current required character - highlighted
            displayHtml += `<span class="highlight-current-tutor">${requiredChar}</span>`;
        } else {
            // Remaining sequence
            displayHtml += requiredChar;
        }
    }
    
    tutorTextDisplay.innerHTML = displayHtml;
}

function startTutor() {
    isTutorActive = true;
    currentTutorExIndex = parseInt(tutorExSelect.value, 10); // Use selected index
    tutorInput.value = '';
    tutorInput.disabled = false;
    tutorBtn.innerText = 'Stop Tutor';
    tutorInput.focus();
    loadTutorExercise(currentTutorExIndex);
}

function stopTutor() {
    isTutorActive = false;
    stopTutorTimer();
    tutorInput.disabled = true;
    tutorBtn.innerText = '‚ñ∂ Start Tutor';
    tutorStatus.innerText = 'Tutor Stopped. Press Start Tutor to resume.';
    tutorTextDisplay.innerText = 'Select an exercise from the menu and press Load Selected Exercise.';
    tutorStats.innerText = 'WPM: 0 | Errors: 0 | Time: 0s (Stopped)';
    speak('Tutor stopped.');
}

function loadTutorExercise(index) {
    if (index >= tutorExercises.length) {
        tutorStatus.innerText = 'üéâ All Exercises Complete! You have finished all 11 exercises.';
        tutorTextDisplay.innerHTML = 'All Exercises Complete!';
        speak('All exercises complete. Congratulations!');
        isTutorActive = false;
        tutorInput.disabled = true;
        tutorBtn.innerText = 'Restart Tutor';
        stopTutorTimer();
        return;
    }

    const exercise = tutorExercises[index];
    tutorCurrentSequence = exercise.sequence;
    tutorCurrentIndex = 0;
    tutorInput.value = '';
    tutorErrors = 0;
    totalCorrectChars = 0;
    stopTutorTimer();
    
    tutorStatus.innerText = `Exercise ${index + 1}: ${exercise.name} | ${exercise.instruction}`;

    if (exercise.type === 'random_key') {
        startRandomKeyMode(exercise.sequence);
    } else {
        tutorInput.disabled = false;
        tutorInput.focus();
        tutorStartTime = null; // Start timer on first keypress
        updateTutorTextDisplay();
        tutorStats.innerText = 'WPM: 0 | Errors: 0 | Time: 0s (Start Typing)';

        // Speak the main instruction and then the first key/word cue
        speak(`Starting Exercise ${index + 1}. ${exercise.name}. ${exercise.instruction}`, 'en-US', 0.85);
        setTimeout(() => {
            const firstSegment = tutorCurrentSequence.trim().split(' ')[0] || tutorCurrentSequence[0];
            speak(`The first key is ${getSpeakableChar(firstSegment)}`, 'en-US', 1.0);
        }, 5000);
    }
}

// Function to populate the dropdown menu
function populateTutorMenu() {
    tutorExSelect.innerHTML = tutorExercises.map((ex, index) => 
        `<option value="${index}">Ex ${index + 1}: ${ex.name}</option>`
    ).join('');
}

// --- Key Event Listeners ---

// 1. Handle Random Key Mode (Exercise 5)
tutorInput.addEventListener('keydown', (e) => {
    if (!isTutorActive || tutorExercises[currentTutorExIndex].type !== 'random_key') return;
    
    if (tutorStartTime === null) startTutorTimer();

    const typedKey = e.key.toLowerCase();
    
    // Ignore function, control, meta keys etc.
    if (['shift', 'control', 'alt', 'meta', 'f2', 'tab', 'escape', 'enter', 'capslock'].includes(typedKey) || typedKey.startsWith('f')) return;

    e.preventDefault(); // Stop the key from being typed into the input field

    // Check if the pressed key is the required key
    if (typedKey === requiredRandomKey) {
        randomKeyIndex++;
        totalCorrectChars++;
        
        if (randomKeyIndex >= randomKeySequence.length) {
            // Exercise complete
            tutorStatus.innerText = `‚úÖ Correct! ${tutorExercises[currentTutorExIndex].name} finished. Errors: ${tutorErrors}. Moving to next exercise.`;
            speak(`Correct! Exercise complete.`, 'en-US');
            stopTutorTimer();
            currentTutorExIndex++;
            // Re-load the menu item for the next exercise to be selected automatically
            tutorExSelect.value = currentTutorExIndex < tutorExercises.length ? currentTutorExIndex.toString() : '0';
            setTimeout(() => loadTutorExercise(currentTutorExIndex), 1500);
            return;
        }

        // Advance to next key
        requiredRandomKey = randomKeySequence[randomKeyIndex];
        tutorStatus.innerText = `‚úÖ Good! Next key: ${getSpeakableChar(requiredRandomKey)}`;
        speak(`Good`, 'en-US', 1.5);
        setTimeout(() => speak(getSpeakableChar(requiredRandomKey), 'en-US', 1.5), 500);
    } else {
        tutorErrors++;
        tutorStatus.innerText = `‚ùå Error! You pressed '${typedKey}'. Correct key is: '${getSpeakableChar(requiredRandomKey)}'`;
        speak(`Error, correct key is ${getSpeakableChar(requiredRandomKey)}`, 'en-US', 1.5);
    }

    updateRandomKeyDisplay();
    calculateTutorStats();
});

// 2. Handle Drill/Word Modes using input for sequence check (BUG FIX APPLIED HERE)
tutorInput.addEventListener('input', (e) => {
    if (!isTutorActive || tutorExercises[currentTutorExIndex].type === 'random_key') return;

    if (tutorStartTime === null) startTutorTimer();

    const typedValue = tutorInput.value;
    const requiredChar = tutorCurrentSequence[tutorCurrentIndex];
    
    // BUG FIX: Check if the user typed an incorrect character at the current required position (tutorCurrentIndex)
    if (typedValue.length > tutorCurrentIndex && typedValue[tutorCurrentIndex] !== requiredChar) {
        
        tutorErrors++;
        const typedWrongChar = typedValue[tutorCurrentIndex];

        // Revert input to the correct position (before the error)
        tutorInput.value = typedValue.substring(0, tutorCurrentIndex);
        
        // Announce the error more clearly
        const requiredDisplay = getSpeakableChar(requiredChar);

        tutorStatus.innerText = `‚ùå Wrong! You typed '${typedWrongChar}'. The correct character is '${requiredDisplay}'.`;
        speak(`Wrong! Correct character is ${requiredDisplay}`, 'en-US');
        
        updateTutorTextDisplay();
        calculateTutorStats();
        return;
    }

    // Correct character typed
    if (typedValue.length === tutorCurrentIndex + 1 && typedValue[tutorCurrentIndex] === requiredChar) {
        // This is only triggered when the user types the correct char and the input length increases by 1.
        totalCorrectChars++;
        tutorCurrentIndex++;
        
        if (tutorCurrentIndex === tutorCurrentSequence.length) {
            // Exercise complete
            tutorStatus.innerText = `‚úÖ Correct! ${tutorExercises[currentTutorExIndex].name} finished. Errors: ${tutorErrors}. Moving to next exercise.`;
            speak(`Correct! Exercise complete.`, 'en-US');
            stopTutorTimer();
            calculateTutorStats();
            currentTutorExIndex++;
            // Re-load the menu item for the next exercise to be selected automatically
            tutorExSelect.value = currentTutorExIndex < tutorExercises.length ? currentTutorExIndex.toString() : '0';
            setTimeout(() => loadTutorExercise(currentTutorExIndex), 1500);
            return;
        }

        // --- FIX FOR SPACE AUDIO START ---
        const nextChar = tutorCurrentSequence[tutorCurrentIndex];
        let nextSpeak = getSpeakableChar(nextChar); 
        
        if (nextChar === ' ') {
            // FIX: Announce the space as requested
            speak('Space', 'en-US', 1.2);
            nextSpeak = 'SPACE'; // for status text
            
            // Queue the next word announcement after the 'Space' announcement for cue
            const nextSegmentMatch = tutorCurrentSequence.substring(tutorCurrentIndex + 1).match(/\S+/);
            if (nextSegmentMatch) {
                 setTimeout(() => speak(nextSegmentMatch[0], 'en-US', 1.2), 500);
                 nextSpeak += ` (Next word cue: ${nextSegmentMatch[0]})`;
            }
        } else {
             // Speak the next key/char (handled by getSpeakableChar for special keys)
            speak(nextSpeak, 'en-US', 1.2);
        }
        
        tutorStatus.innerText = `‚úÖ Correct. Next: ${nextSpeak}`;
        // --- FIX FOR SPACE AUDIO END ---
    }
    
    updateTutorTextDisplay();
    calculateTutorStats();
});

// Event handler for Start/Stop button
tutorBtn.addEventListener('click', ()=>{
    if(tutorBtn.innerText === 'Stop Tutor') {
        stopTutor();
    } else {
        startTutor();
    }
});

// Event handler for loading a specific exercise from the menu
loadExBtn.addEventListener('click', () => {
    if (isTutorActive) stopTutor(); // Stop any active tutor session first
    
    currentTutorExIndex = parseInt(tutorExSelect.value, 10);
    const exercise = tutorExercises[currentTutorExIndex];
    
    // Set up the state and UI for starting
    tutorCurrentSequence = exercise.sequence;
    tutorCurrentIndex = 0;
    tutorErrors = 0;
    totalCorrectChars = 0;
    
    tutorStatus.innerText = `Ready to start: Exercise ${currentTutorExIndex + 1}: ${exercise.name}. Press Start Tutor to begin.`;
    tutorInput.value = '';
    tutorInput.disabled = true; 
    tutorBtn.innerText = '‚ñ∂ Start Tutor';
    tutorStats.innerText = 'WPM: 0 | Errors: 0 | Time: 0s';

    // Preview the text
    if (exercise.type === 'random_key') {
         tutorTextDisplay.innerText = `${exercise.instruction}\n\nKeys: ${exercise.sequence.split(' ').slice(0, 15).join(', ')}...`;
    } else {
         tutorTextDisplay.innerText = exercise.sequence;
    }

    speak(`Loaded exercise ${currentTutorExIndex + 1}: ${exercise.name}. Press Start Tutor when ready.`);
});


function initializeTypingTutor() {
    // Initialize the menu
    populateTutorMenu();
    // Default load the first exercise display without starting
    loadExBtn.click();
}


/* ==================== Typing WPM Test (New Tool) ==================== */
const wpmText = "The quick brown fox jumps over the lazy dog this is a test to check your typing speed and accuracy please type the words as fast as you can to get your words per minute score practice every day to increase your proficiency and efficiency in all data entry tasks";
let wpmStartTime;
let wpmWordIndex = 0;
let wpmWords = [];
let wpmErrors = 0;
let wpmCorrectCharacters = 0; 
let wpmFullTypedCharacters = 0; 

const wpmInput = document.getElementById('wpmInput');
const wpmTextDiv = document.getElementById('wpmText');
const wpmResultsDiv = document.getElementById('wpmResults');
const wpmStartBtn = document.getElementById('wpmStartBtn');

function calculateWPM() {
    if (!wpmStartTime) return { wpm: 0, accuracy: 0, errors: 0, time: 0 };

    const timeElapsedSeconds = (new Date().getTime() - wpmStartTime) / 1000;
    const minutes = timeElapsedSeconds / 60;
    
    const netWPM = minutes > 0 ? Math.round((wpmCorrectCharacters / 5) / minutes) : 0;
    const accuracy = wpmFullTypedCharacters > 0 ? ((wpmCorrectCharacters / wpmFullTypedCharacters) * 100).toFixed(1) : 0;
    
    return { wpm: netWPM, errors: wpmErrors, time: Math.floor(timeElapsedSeconds), accuracy: accuracy };
}

function resetWPMTest() {
    wpmWords = wpmText.split(' ');
    wpmWordIndex = 0;
    wpmErrors = 0;
    wpmCorrectCharacters = 0; 
    wpmFullTypedCharacters = 0; 
    wpmStartTime = null;
    wpmInput.value = '';
    wpmInput.disabled = false;
    wpmStartBtn.innerText = 'Restart WPM Test';
    wpmResultsDiv.innerText = 'WPM: 0 | Errors: 0 | Time: 0s | Acc: 0%';
    
    wpmTextDiv.innerHTML = `<span id="wpmCurrentWord" style="background-color: yellow; padding: 2px;">${wpmWords[0]}</span> ${wpmWords.slice(1).join(' ')}`;
    wpmInput.focus();
    speak("WPM test started. Type the highlighted word.");
}

function updateWPMDisplay() {
    const results = calculateWPM();
    wpmResultsDiv.innerText = `WPM: ${results.wpm} | Errors: ${results.errors} | Time: ${results.time}s | Acc: ${results.accuracy}%`;
}

function checkWPMInput(e) {
    if (!wpmStartTime) { wpmStartTime = new Date().getTime(); }
    
    const typedValue = wpmInput.value;
    const currentWord = wpmWords[wpmWordIndex];
    
    // Total characters for accuracy calculation
    wpmFullTypedCharacters = wpmWords.slice(0, wpmWordIndex).reduce((sum, word) => sum + word.length + 1, 0); 
    wpmFullTypedCharacters += typedValue.length; 
    
    // Check for word completion (space pressed after correct word)
    if (typedValue.endsWith(' ') && typedValue.trim() === currentWord) {
        
        wpmCorrectCharacters += currentWord.length + 1; // +1 for the space

        wpmWordIndex++;
        wpmInput.value = '';
        
        if (wpmWordIndex < wpmWords.length) {
            const typedPart = `<span style="color: green">${wpmWords.slice(0, wpmWordIndex).join(' ')} </span>`;
            const after = wpmWords.slice(wpmWordIndex + 1).join(' ');
            
            wpmTextDiv.innerHTML = `${typedPart}<span id="wpmCurrentWord" style="background-color: yellow; padding: 2px;">${wpmWords[wpmWordIndex]}</span> ${after}`;
            
            speak(wpmWords[wpmWordIndex]);
        } else {
            finishWPMTest();
        }
    } else {
        const typedTrimmed = typedValue.trim();
        const currentWordSpan = document.getElementById('wpmCurrentWord');
        
        let localCorrectChars = 0;
        let html = '';

        for (let i = 0; i < currentWord.length; i++) {
            const char = currentWord[i];
            const typedChar = typedTrimmed[i];
            if (i < typedTrimmed.length) {
                if (char === typedChar) {
                    html += `<span style="color: green;">${char}</span>`;
                    localCorrectChars++;
                } else {
                    html += `<span style="color: red;">${char}</span>`;
                    // Increment error count only on the first mistake for a character
                    if(e.inputType === 'insertText' && typedTrimmed.length - 1 === i) {
                         wpmErrors++;
                    }
                }
            } else {
                html += char;
            }
        }
        
        if (currentWordSpan) {
             currentWordSpan.innerHTML = html;
        }

        // Recalculate total correct characters based on previous words and current word
        wpmCorrectCharacters = wpmWords.slice(0, wpmWordIndex).reduce((sum, word) => sum + word.length + 1, 0);
        wpmCorrectCharacters += localCorrectChars;
    }
    
    updateWPMDisplay();
}

function finishWPMTest() {
    const results = calculateWPM();
    
    wpmInput.disabled = true;
    wpmInput.removeEventListener('input', checkWPMInput);
    wpmTextDiv.innerHTML = `<span style="color: green">${wpmWords.join(' ')}</span>`;

    const finalResults = `Test Finished! WPM: ${results.wpm}. Errors: ${results.errors}. Time: ${results.time}s. Accuracy: ${results.accuracy}%.`;
    wpmResultsDiv.innerText = finalResults;
    speak(`Test finished. Your words per minute is ${results.wpm} with ${results.accuracy} percent accuracy.`);
    wpmStartTime = null;
}

function initializeWPMTest() {
    wpmStartBtn.addEventListener('click', resetWPMTest);
    wpmInput.addEventListener('input', checkWPMInput);
}


/* ==================== QR Code Generator ==================== */
const qrOutput = document.getElementById('qrOutput');
let qrcodeInstance = null; // Store QR code instance

document.getElementById('qrGenerateBtn').addEventListener('click', ()=>{
    const text = document.getElementById('qrInput').value.trim();
    
    if(!text){
        qrOutput.innerHTML = 'Enter text to generate QR code';
        speak('Enter text to generate QR code');
        return;
    }

    qrOutput.innerHTML = ''; // Clear previous output
    
    // Create new QR Code
    qrcodeInstance = new QRCode(qrOutput, {
        text: text,
        width: 150,
        height: 150,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
    });

    speak('QR Code generated successfully');
});


/* ==================== Text to Speech ==================== */
document.getElementById('ttsSpeakBtn').addEventListener('click', ()=>{
    const text = document.getElementById('ttsInput').value;
    if(text){
        speak(text, 'en-IN', 1.0);
    } else {
        speak('Please enter text to speak');
    }
});


/* ==================== Translator ==================== */
document.getElementById('translateBtn').addEventListener('click', ()=>{
    const text = document.getElementById('translateInput').value.trim();
    if(!text){
        speak('Enter text to translate');
        return;
    }
    
    const sourceLang = document.getElementById('translateSource').value;
    const targetLang = document.getElementById('translateTarget').value;
    
    const translateUrl = `https://translate.google.com/?sl=${sourceLang}&tl=${targetLang}&text=${encodeURIComponent(text)}&op=translate`;
    window.open(translateUrl, '_blank');
    
    speak('Opening translation result in a new tab');
});


/* ==================== OCR & PDF ==================== */
if(typeof pdfjsLib !== 'undefined') pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

let pdfDoc = null;
let totalPages = 0;

const fileInput = document.getElementById('fileInput');
const processBtn = document.getElementById('processBtn');
const docOutput = document.getElementById('doc-output');
const pdfControls = document.getElementById('pdf-controls');
const pageNumberInput = document.getElementById('pageNumberInput');
const goPageBtn = document.getElementById('goPageBtn');
const pageInfo = document.getElementById('pageInfo');

async function displayPdfPage(pageNum){
  if(!pdfDoc){ docOutput.innerText = 'No PDF loaded'; return; }
  if(pageNum < 1 || pageNum > totalPages){ docOutput.innerText = 'Invalid page number'; return; }
  docOutput.innerText = 'Loading page...';
  try{
    const page = await pdfDoc.getPage(pageNum);
    const txt = await page.getTextContent();
    const pageText = txt.items.map(i=>i.str).join(' ');
    
    // Simple cleaning
    const cleanedText = pageText.replace(/\s+/g, ' ').trim();
    
    docOutput.innerText = `--- PAGE ${pageNum} of ${totalPages} ---\n\n` + (cleanedText || `Page ${pageNum} seems empty`);
    pageInfo.innerText = `Page ${pageNum} of ${totalPages}`;
    autoReadOCR(cleanedText || '');
  }catch(e){
    docOutput.innerText = 'Error reading page. PDF might be image-based.';
    console.error("PDF Page Read Error:", e);
    speak('Error reading page. PDF might be image-based.');
  }
}

goPageBtn.addEventListener('click', ()=> {
  const n = parseInt(pageNumberInput.value || '1',10);
  if(pdfDoc) displayPdfPage(n);
});

processBtn.addEventListener('click', async ()=>{
  const f = fileInput.files[0];
  if(!f){ docOutput.innerText = 'Select a file first'; speak('Select a file first'); return; }
  docOutput.innerText = 'Processing file (this may take a few seconds)';
  speak('Processing file. This may take a few seconds.');
  
  pdfDoc = null; // Clear previous PDF
  pdfControls.style.display = 'none';

  if(f.type === 'application/pdf'){
    try{
      const ab = await f.arrayBuffer();
      // Increase maxImageSize for better OCR quality on image-based PDFs
      pdfDoc = await pdfjsLib.getDocument({data:ab, maxImageSize: 2048}).promise; 
      totalPages = pdfDoc.numPages;
      pdfControls.style.display = 'inline-flex';
      pageNumberInput.max = totalPages;
      pageNumberInput.value = 1;
      displayPdfPage(1);
    }catch(e){
      console.error(e);
      docOutput.innerText = 'PDF read error. File might be corrupted or password protected.';
      speak('PDF read error. File might be corrupted.');
    }
    return;
  }
  if(f.type.startsWith('image/')){
    if(typeof Tesseract === 'undefined'){ docOutput.innerText = 'OCR library not loaded'; return; }
    try{
      docOutput.innerText = 'Starting OCR (Tesseract): Loading worker...';
      const worker = Tesseract.createWorker({ 
          logger: m => {
            const status = m.status.replace(/_/g, ' ');
            const progress = m.progress ? ` (${(m.progress * 100).toFixed(0)}%)` : '';
            docOutput.innerText = `OCR Status: ${status}${progress}`;
          },
          preserveInterwordSpaces: true 
      });
      await worker.load();
      // Added all requested languages
      await worker.loadLanguage('eng+hin+guj'); 
      await worker.initialize('eng+hin+guj');
      await worker.setParameters({
        tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
        tessedit_pageseg_mode: Tesseract.PSM.AUTO 
      });
      
      const { data: { text } } = await worker.recognize(f);
      await worker.terminate();
      
      const cleanedText = text.replace(/\s+/g, ' ').trim();
      docOutput.innerText = cleanedText || 'No clear text recognized. Try a clearer image.';
      autoReadOCR(cleanedText || '');
    }catch(err){
      console.error(err);
      docOutput.innerText = 'OCR failed. Try a clearer image or a different language setting.';
      speak('OCR failed.');
    }
    return;
  }
  docOutput.innerText = 'Unsupported file type. Only Image (JPG, PNG) and PDF are supported.';
  speak('Unsupported file type. Only Image and PDF are supported.');
});

/* ======== language detection & reading ======== */
function detectLang(text){
  if(!text) return 'en-IN';
  if(/[\u0A80-\u0AFF]/.test(text)) return 'gu-IN'; // Check for Gujarati script
  if(/[\u0900-\u097F]/.test(text)) return 'hi-IN'; // Check for Devanagari (Hindi) script
  // Fallback to English if predominantly Latin characters
  if(/[A-Za-z]/.test(text)) return 'en-IN';
  return 'en-IN';
}

function speakLongText(text, lang){
  if(!('speechSynthesis' in window)){ document.getElementById('readStatus').innerText = 'Speech not supported'; return; }
  const forced = document.getElementById('forceLang').value;
  const useLang = forced || lang || detectLang(text);
  document.getElementById('readStatus').innerText = `Reading in ${useLang}`;
  
  const cleaned = text.replace(/\s+/g,' ').trim();
  const chunkSize = 300;
  const chunks = [];
  let i = 0;
  while(i < cleaned.length){
    let part = cleaned.slice(i, i + chunkSize);
    let cutPoint = i + chunkSize;
    if (cleaned.length > i + chunkSize) {
        let lastSpace = cleaned.lastIndexOf(' ', i + chunkSize);
        if (lastSpace > i + chunkSize - 50 && lastSpace > i) { 
            cutPoint = lastSpace;
        }
    }
    chunks.push(cleaned.slice(i, cutPoint).trim());
    i = cutPoint;
  }
  let idx = 0;
  function playChunk(){
    if(idx >= chunks.length){ document.getElementById('readStatus').innerText = 'Read complete'; return; }
    const u = new SpeechSynthesisUtterance(chunks[idx]);
    u.lang = useLang;
    u.rate = (useLang === 'en-IN')?0.95:0.9;
    u.onend = ()=>{ idx++; setTimeout(playChunk, 200); };
    u.onerror = (event)=>{ 
      console.error('Speech synthesis error:', event.error);
      idx++; 
      setTimeout(playChunk, 200); 
    };
    speechSynthesis.speak(u);
  }
  try{ speechSynthesis.cancel(); }catch(e){}
  playChunk();
}

document.getElementById('readDoc').addEventListener('click', ()=>{
  const text = docOutput.innerText || '';
  if(!text.trim()){ document.getElementById('readStatus').innerText = 'No text to read'; return; }
  const lang = detectLang(text);
  speakLongText(text, lang);
});
document.getElementById('stopRead').addEventListener('click', ()=>{ try{ speechSynthesis.cancel(); }catch(e){} document.getElementById('readStatus').innerText = 'Stopped'; });

function autoReadOCR(text){
  if(!text || !text.trim()) return;
  const auto = document.getElementById('autoLang').checked;
  const forced = document.getElementById('forceLang').value;
  if(!auto && !forced) return;
  const lang = forced || detectLang(text);
  setTimeout(()=> speakLongText(text, lang), 300);
}

/* ==================== Location ==================== */
const locBtn = document.getElementById('locBtn');
const locOut = document.getElementById('locationOutput');
locBtn.addEventListener('click', ()=>{
  locOut.innerText = 'Locating...';
  if(!navigator.geolocation){ locOut.innerText = 'Geolocation not supported by this browser'; return; }
  
  const options = {
    enableHighAccuracy: true,
    timeout: 10000, 
    maximumAge: 0
  };
  
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude.toFixed(6);
    const lon = pos.coords.longitude.toFixed(6);
    const mapsUrl = `https://maps.google.com/?q=$${lat},${lon}`;
    locOut.innerHTML = `Lat ${lat} Lon ${lon} ‚Äî <a href="${mapsUrl}" target="_blank">Open in Google Maps</a>`;
    speak(`Location found. Latitude ${lat} Longitude ${lon}`);
  }, err=>{
    let msg = 'An unknown error occurred';
    if(err.code === 1) msg = 'Permission denied. Please allow location access in browser settings';
    else if(err.code === 2) msg = 'Position unavailable. Unable to determine location';
    else if(err.code === 3) msg = 'Request timed out';
    
    locOut.innerText = `Error: ${msg}`;
    speak(`Location error: ${msg}`);
  }, options);
});

/* ==================== Games ==================== */

// Hand Cricket Logic
const hcStatus = document.getElementById('hcStatus');
const hcInput = document.getElementById('hcInput');
const hcPlay = document.getElementById('hcPlay');
const hcReset = document.getElementById('hcReset');

let hcTarget = 0;
let hcScore = 0;
let hcState = 'batting'; // 'batting' or 'bowling'

function resetHandCricket(){
    hcTarget = 0;
    hcScore = 0;
    hcState = 'batting';
    hcStatus.innerText = 'You are batting. Enter a number 1-6 to score.';
    hcInput.value = '';
    speak('Hand Cricket reset. You are batting. Enter a number 1 to 6.');
}

function initializeGames() {
    // Hand Cricket
    hcReset.addEventListener('click', resetHandCricket);
    hcPlay.addEventListener('click', ()=>{
        if(hcState === 'finished') { speak('Game finished. Please reset to play again.'); return; }
        const playerRun = parseInt(hcInput.value);
        if (isNaN(playerRun) || playerRun < 1 || playerRun > 6) {
            hcStatus.innerText = 'Invalid input. Enter a number between 1 and 6.';
            speak('Invalid input. Enter a number between 1 and 6.');
            return;
        }

        const computerRun = Math.floor(Math.random() * 6) + 1;
        hcInput.value = '';
        hcInput.focus();

        if (hcState === 'batting') {
            if (playerRun === computerRun) {
                hcTarget = hcScore + 1;
                hcScore = 0; 
                hcState = 'bowling';
                hcStatus.innerText = `OUT! You played ${playerRun}, Computer bowled ${computerRun}. Your total score is ${hcTarget - 1}. Now computer is batting. You are bowling. Computer needs ${hcTarget} to win.`;
                speak(`OUT! Your score is ${hcTarget - 1}. Computer needs ${hcTarget} to win. You are bowling. Enter a number 1 to 6.`);
            } else {
                hcScore += playerRun;
                hcStatus.innerText = `You scored ${playerRun}. Computer bowled ${computerRun}. Total score: ${hcScore}.`;
                speak(`You scored ${playerRun}. Total score ${hcScore}.`);
            }
        } else if (hcState === 'bowling') {
            if (playerRun === computerRun) {
                const runDiff = Math.abs((hcTarget - 1) - hcScore);
                
                if (hcScore < hcTarget - 1) {
                    hcStatus.innerText = `OUT! Computer score ${hcScore}. Target was ${hcTarget - 1}. YOU WON by ${runDiff} runs!`;
                    speak(`OUT! Computer score ${hcScore}. You won by ${runDiff} runs.`);
                } else if (hcScore === hcTarget - 1) {
                     hcStatus.innerText = `OUT! Computer score ${hcScore}. Target was ${hcTarget - 1}. It was a TIE. Game over.`;
                     speak(`It was a TIE. Game over.`);
                } else {
                     hcStatus.innerText = `OUT! Computer score ${hcScore}. Game over.`;
                     speak(`Game over.`);
                }

                hcState = 'finished';

            } else {
                hcScore += computerRun;
                if (hcScore >= hcTarget) {
                    hcStatus.innerText = `Computer scored ${computerRun}. Total computer score ${hcScore}. Target was ${hcTarget}. COMPUTER WON!`;
                    speak(`Computer won with score ${hcScore}.`);
                    hcState = 'finished';
                } else {
                    const required = hcTarget - hcScore;
                    hcStatus.innerText = `Computer scored ${computerRun}. Total computer score ${hcScore}. Computer needs ${required} more runs to win.`;
                    speak(`Computer scored ${computerRun}. Needs ${required} more runs.`);
                }
            }
        }
    });

    // Snakes & Ladders (Simplified)
    const snlStatus = document.getElementById('snlStatus');
    const snlRoll = document.getElementById('snlRoll');
    const snlReset = document.getElementById('snlReset');
    const snlDice = document.getElementById('snlDice');

    let snlPosition = 1;
    const snlJumps = {
        4: 14, 9: 31, 20: 38, 28: 84, 40: 59, 63: 81, 71: 91, // Ladders
        17: 7, 54: 34, 62: 19, 64: 60, 87: 24, 93: 73, 95: 75, 98: 78 // Snakes
    };

    function resetSnakesLadders(){
        snlPosition = 1;
        snlStatus.innerText = 'Your position is 1. Roll the dice to begin. First to 100 wins.';
        snlDice.innerText = '-';
        speak('Snakes and Ladders reset. Your position is 1.');
    }
    snlReset.addEventListener('click', resetSnakesLadders);
    resetSnakesLadders(); // Initial setup

    snlRoll.addEventListener('click', ()=>{
        if(snlPosition >= 100) return;
        const roll = Math.floor(Math.random() * 6) + 1;
        snlDice.innerText = roll;
        
        let newPosition = snlPosition + roll;

        if (newPosition > 100) {
            snlStatus.innerText = `You rolled ${roll} but need exactly ${100 - snlPosition} to win. You stay at ${snlPosition}.`;
            speak(`You rolled ${roll} but need exactly ${100 - snlPosition} to win. You stay at ${snlPosition}.`);
            return;
        }
        
        let jumpMsg = '';
        if (snlJumps[newPosition]) {
            const finalPosition = snlJumps[newPosition];
            if (finalPosition > newPosition) {
                jumpMsg = ` Wow! A Ladder from ${newPosition} to ${finalPosition}.`;
            } else {
                jumpMsg = ` Oh no! A Snake from ${newPosition} down to ${finalPosition}.`;
            }
            newPosition = finalPosition;
        }
        
        snlPosition = newPosition;

        if (snlPosition === 100) {
            snlStatus.innerText = `üéâ You rolled ${roll} and landed on 100. You win!`;
            speak(`You rolled ${roll} and landed on 100. You win!`);
            return;
        }
        
        snlStatus.innerText = `You rolled ${roll}. Your new position is ${snlPosition}.${jumpMsg}`;
        speak(`You rolled ${roll}. Your new position is ${snlPosition}. ${jumpMsg}`);
    });

    // Ludo Race (Simplified one player vs three AI)
    const ludoStatus = document.getElementById('ludoStatus');
    const ludoRoll = document.getElementById('ludoRoll');
    const ludoReset = document.getElementById('ludoReset');
    const ludoScores = document.getElementById('ludoScores');

    let ludoPositions = { player: 0, ai1: 0, ai2: 0, ai3: 0 };
    const LUDO_END = 50;
    let ludoTurn = 'player';
    let ludoGameActive = true;

    function resetLudo(){
        ludoPositions = { player: 0, ai1: 0, ai2: 0, ai3: 0 };
        ludoTurn = 'player';
        ludoGameActive = true;
        ludoStatus.innerText = 'Ludo Race reset. First to 50 wins. Your turn.';
        updateLudoScores();
        speak('Ludo Race reset. Your turn.');
    }
    ludoReset.addEventListener('click', resetLudo);
    resetLudo(); // Initial setup

    function updateLudoScores(){
        ludoScores.innerHTML = `Player: ${ludoPositions.player} | AI 1: ${ludoPositions.ai1} | AI 2: ${ludoPositions.ai2} | AI 3: ${ludoPositions.ai3}`;
    }

    function checkLudoWin(player){
        if (ludoPositions[player] >= LUDO_END) {
            ludoStatus.innerText = `${player.toUpperCase().replace('AI', 'AI ')} wins!`;
            speak(`${player.toUpperCase().replace('AI', 'AI ')} wins!`);
            ludoGameActive = false;
            return true;
        }
        return false;
    }

    function rollLudoDice(){
        return Math.floor(Math.random() * 6) + 1;
    }

    function handleAITurn(ai){
        if(!ludoGameActive) return;
        const roll = rollLudoDice();
        ludoPositions[ai] += roll;
        
        if (checkLudoWin(ai)) return;
        
        // Announce AI move
        const aiName = ai.toUpperCase().replace('AI', 'AI ');
        ludoStatus.innerText = `It was ${aiName}'s turn. They rolled ${roll}. New position: ${ludoPositions[ai]}.`;
        updateLudoScores();
        
        // Set up next turn logic
        if (ai === 'ai3') {
            ludoStatus.innerText += ' Your turn.';
            speak(`${aiName} rolled ${roll}. Your turn.`);
            ludoTurn = 'player';
        }
    }

    ludoRoll.addEventListener('click', ()=>{
        if (!ludoGameActive || ludoTurn !== 'player') return;

        const roll = rollLudoDice();
        ludoPositions.player += roll;
        
        if (checkLudoWin('player')) return;

        ludoStatus.innerText = `You rolled ${roll}. Your new position is ${ludoPositions.player}.`;
        updateLudoScores();
        speak(`You rolled ${roll}. Your new position is ${ludoPositions.player}.`);

        ludoTurn = 'ai1';
        
        // AI turns sequence
        setTimeout(() => handleAITurn('ai1'), 1500);
        setTimeout(() => { if(ludoGameActive) handleAITurn('ai2'); }, 3000);
        setTimeout(() => { if(ludoGameActive) handleAITurn('ai3'); }, 4500);
    });
}
</script>
</body>
</html>
